<!--
@author Francisco Miguel Aramburo Torres - atfm05@gmail.com
-->

<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../components/paper-card/paper-card.html">
<link rel="import" href="../components/iron-ajax/iron-ajax.html">

<link rel="import" href="../components/paper-slider/paper-slider.html">

<link rel="import" href="../components/paper-time-picker/paper-time-picker.html">
<link rel="import" href="../components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../components/google-map/google-map.html">
<link rel="import" href="../components/paper-dialog/paper-dialog.html">

<link rel="import" href="../components/paper-styles/color.html">
<link rel="import" href="../pl-utils/arckane-styles.html">

<dom-module id="edit-session">
  <style include="paper-time-picker-dialog-style"></style>
  <style include="paper-date-picker-dialog-style"></style>
  <style>
    * {
      box-sizing: border-box;
    }

    :host {
      --default-primary-color: var(--arckane-aqua-100);
      --paper-slider-height: 3px;
      --paper-slider-knob-color: var(--arckane-purple-200);
      --paper-slider-active-color: var(--arckane-purple-200);
      --paper-slider-pin-color: var(--arckane-aqua-100);
    }

    paper-card {
      width: 337px;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    paper-slider {
      width: 100%;
    }

    .card-actions paper-button {
      @apply(--layout-flex);
      color: var(--arckane-purple-200);
    }

    .map-container {
      height: 330px;
    }

    .date .day {
      font-size: 34px;
    }

    .date .time {
      font-size: 20px;
    }

    .date .length {
      margin-top: 10px;
      font-size: 16px;
      color: var(--google-grey-500);
    }

  </style>

  <template>
    <iron-ajax
      id="ajax"
      method="GET"
      on-response="_dataResponse"
      last-response="{{data}}"
      handle-as="json">
    </iron-ajax>

    <iron-ajax
      id="updateSessionRequest"
      method="POST">
    </iron-ajax>

    <!-- Date, time and length card -->
    <paper-card>

      <!-- Display -->
      <div class="card-content date">
        <div class="day">{{_dateFormat(date, 'LL')}}</div>
        <div class="time">{{time}}</div>
        <div class="length"><span>{{length}}</span> hrs.</div>
        <paper-slider pin snaps max="10" max-markers="10" step="0.5" value="{{length}}"></paper-slider>
      </div>

      <!-- Action buttons -->
      <div class="booking card-actions horizontal layout">
        <paper-button on-tap="_showDateDialog">
          <iron-icon icon="create"></iron-icon>
          Date
        </paper-button>
        <paper-button on-tap="_showTimeDialog">
          <iron-icon icon="create"></iron-icon>
          Time
        </paper-button>
      </div>

      <!-- Date picker dialog -->
      <paper-dialog id="dateDialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="_dismissDateDialog">
        <paper-date-picker id="datePicker" min-date="[[minDate]]" date="[[date]]"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>

      <!-- Time picker dialog -->
      <paper-dialog id="timeDialog" class="paper-time-picker-dialog" modal on-iron-overlay-closed="_dismissTimeDialog">
        <paper-time-picker id="timePicker" time="[[time]]"></paper-time-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>Ok</paper-button>
        </div>
      </paper-dialog>

    </paper-card>

    <!-- Topics and skills -->
    <paper-card heading="Topics and Skills"></paper-card>

    <paper-card heading="Pricing and Apprentices"></paper-card>

    <paper-card heading="Location">
      <div class="card-content">
      </div>
      <div class="map-container">
        <google-map latitude="37.77493" longitude="-122.41942"></google-map>
      </div>
    </paper-card>
  </template>
</dom-module>

<script>
  Polymer({

    is: "edit-session",

    properties: {
      user: String,
      sessionId: String,
      time: {
        type: String,
        observer: "_dateChanged"
      },
      date: {
        type: Object,
        observer: "_dateChanged"
      },
      length: {
        type: String,
        observer: "_lengthChanged"
      }
    },

    _dataResponse: function () {
      // Safety flag to update database.
      this.safetyFlag = false;

      var responseDate = new Date(this.data["session_date"]);
      var hours = responseDate.getHours();
      var minutes = responseDate.getMinutes();
      var part = "";

      if (hours > 12) part = "PM";
      else part = "AM";
      if (hours > 12) hours = hours - 12;
      if (minutes < 10) minutes = "0"+minutes;
      this.time = hours+":"+minutes+" "+part;

      var utcHours = responseDate.getUTCHours();
      var utcMinutes = responseDate.getUTCMinutes();
      this.date = new Date(responseDate.getTime() - (utcHours * 60 * 60 * 1000) - (utcMinutes * 60 * 1000));

      this.minDate = new Date(this.data["creation_timestamp"]);
      this.length = this.data["length"];

      this.async(function () {
        this.safetyFlag = true;
      }, 500)
    },

    _updateSession: function (prop, value, numeric) {
      this.$.updateSessionRequest.url = "/api/schedules/update/session/" + this.sessionId;
      this.$.updateSessionRequest.params = {
        prop: prop,
        value: value,
        numeric: numeric
      };
      this.$.updateSessionRequest.generateRequest();
    },

    _dateChanged: function (date) {
      if (this.data && this.safetyFlag) {
        var year = this.date.getFullYear();
        var month = this.date.getMonth();
        var day = this.date.getDate();
        var hour = this.$.timePicker.hour;
        var minute = this.$.timePicker.minute;
        var newDate = new Date(year, month, day, hour, minute, 0);
        this._updateSession("session_date", newDate.getTime(), true);
      }
    },

    _lengthChanged: function (length) {
      if (this.data && this.safetyFlag) {
        this._updateSession("length", length, true);
      }
    },

    _showTimeDialog: function () {
      this.$.timeDialog.toggle();
    },

    _dismissTimeDialog: function(event) {
      if (event.detail.confirmed) {
        this.time = this.$.timePicker.time;
      }
    },

    _dateFormat: function(date, format) {
      return moment(date).format(format);
    },

    _dismissDateDialog: function(event) {
      if (event.detail.confirmed) {
        this.date = this.$.datePicker.date;
      }
    },

    _showDateDialog: function() {
      this.$.dateDialog.toggle();
    },

    ready: function () {
      this.$.ajax.url = "/api/schedules/editdata/session/"+this.sessionId
      this.$.ajax.generateRequest();
    }
  });
</script>
