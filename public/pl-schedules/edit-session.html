<!--
@author Francisco Miguel Aramburo Torres - atfm05@gmail.com
-->

<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../components/paper-card/paper-card.html">
<link rel="import" href="../components/iron-ajax/iron-ajax.html">

<link rel="import" href="../components/paper-time-picker/paper-time-picker.html">
<link rel="import" href="../components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../components/google-map/google-map.html">
<link rel="import" href="../components/paper-dialog/paper-dialog.html">

<link rel="import" href="../components/paper-styles/color.html">
<link rel="import" href="../pl-utils/arckane-styles.html">

<dom-module id="edit-session">
  <style include="paper-time-picker-dialog-style"></style>
  <style include="paper-date-picker-dialog-style"></style>
  <style>
    * {
      box-sizing: border-box;
    }

    :host {
      --default-primary-color: var(--arckane-aqua-100);
    }

    paper-card {
      width: 337px;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .card-actions paper-button {
      @apply(--layout-flex);
      color: var(--arckane-purple-200);
    }

    .map-container {
      height: 330px;
    }

    .date .day {
      font-size: 34px;
    }

    .date .time {
      font-size: 20px;
    }

    .date .length {
      margin-top: 10px;
      font-size: 16px;
      color: var(--google-grey-500);
    }

  </style>

  <template>
    <iron-ajax
      id="ajax"
      method="GET"
      on-response="_dataResponse"
      last-response="{{data}}"
      handle-as="json">
    </iron-ajax>

    <!-- Date, time and length ajax -->
    <iron-ajax
      id="updateSessionDateRequest"
      method="POST">
    </iron-ajax>

    <!-- DAte, time and length card -->
    <paper-card>
      <div class="card-content date">
        <div class="day">{{dateFormat(date, 'LL')}}</div>
        <div class="time">{{time}}</div>
      </div>

      <div class="booking card-actions horizontal layout">
        <paper-button on-tap="showDateDialog">
          <iron-icon icon="create"></iron-icon>
          Date
        </paper-button>
        <paper-button on-tap="showTimeDialog">
          <iron-icon icon="create"></iron-icon>
          Time
        </paper-button>
      </div>

      <!-- Date picker dialog -->
      <paper-dialog id="dateDialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="dismissDateDialog">
        <paper-date-picker id="datePicker" date="[[date]]"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>

      <!-- Time picker dialog -->
      <paper-dialog id="timeDialog" class="paper-time-picker-dialog" modal on-iron-overlay-closed="dismissTimeDialog">
        <paper-time-picker id="timePicker" time="[[time]]"></paper-time-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>Ok</paper-button>
        </div>
      </paper-dialog>

    </paper-card>

    <!-- Topics and skills -->
    <paper-card heading="Topics and Skills"></paper-card>

    <paper-card heading="Pricing and Apprentices"></paper-card>

    <paper-card heading="Location">
      <div class="card-content">
      </div>
      <div class="map-container">
        <google-map latitude="37.77493" longitude="-122.41942"></google-map>
      </div>
    </paper-card>
  </template>
</dom-module>

<script>
  Polymer({

    is: "edit-session",

    properties: {
      user: String,
      sessionId: String,
      time: {
        type: String,
        observer: "_timeChanged"
      },
      date: {
        type: Object,
        observer: "_dateChanged"
      }
    },

    _dataResponse: function () {
      // Safety flag to update database.
      this.safetyFlag = false;

      var responseDate = new Date(this.data["session_date"]);
      var hours = responseDate.getHours();
      var minutes = responseDate.getMinutes();
      var part = "";

      if (hours > 12) part = "PM";
      else part = "AM";
      if (hours > 12) hours = hours - 12;
      if (minutes < 10) minutes = "0"+minutes;
      this.time = hours+":"+minutes+" "+part;

      var utcHours = responseDate.getUTCHours();
      var utcMinutes = responseDate.getUTCMinutes();
      this.date = new Date(responseDate.getTime() - (utcHours * 60 * 60 * 1000) - (utcMinutes * 60 * 1000));

      this.async(function () {
        this.safetyFlag = true;
      }, 500)
    },

    _timeChanged: function (time) {
      if (this.data && this.safetyFlag) {
        var hour = this.$.timePicker.hour;
        var minute = this.$.timePicker.minute;
        var newDate = new Date(this.date.getFullYear(), this.date.getMonth(), this.date.getDate(), hour, minute, 0);
        this._updateSessionDate(newDate.getTime());
      }
    },

    _dateChanged: function (date) {
      if (this.data && this.safetyFlag) {
        var year = date.getFullYear();
        var month = date.getMonth();
        var day = date.getDate();
        var hour = this.$.timePicker.hour;
        var minute = this.$.timePicker.minute;
        var newDate = new Date(year, month, day, hour, minute, 0);
        this._updateSessionDate(newDate.getTime());
      }
    },

    _updateSessionDate: function (date) {
      this.$.updateSessionDateRequest.url = "/api/schedules/update/session/" + this.sessionId;
      this.$.updateSessionDateRequest.params = {
        prop: "session_date",
        value: date,
        numeric: true
      };
      this.$.updateSessionDateRequest.generateRequest();
    },

    showTimeDialog: function () {
      this.$.timeDialog.toggle();
    },

    dismissTimeDialog: function(event) {
      if (event.detail.confirmed) {
        this.time = this.$.timePicker.time;
      }
    },

    dateFormat: function(date, format) {
      return moment(date).format(format);
    },

    dismissDateDialog: function(event) {
      if (event.detail.confirmed) {
        this.date = this.$.datePicker.date;
      }
    },

    showDateDialog: function() {
      this.$.dateDialog.toggle();
    },

    ready: function () {
      this.$.ajax.url = "/api/schedules/editdata/session/"+this.sessionId
      this.$.ajax.generateRequest();
    }
  });
</script>
