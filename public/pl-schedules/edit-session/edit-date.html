<!--
@author Francisco Miguel Aramburo Torres - atfm05@gmail.com
-->

<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/paper-card/paper-card.html">
<link rel="import" href="../../components/paper-slider/paper-slider.html">

<link rel="import" href="../../components/paper-time-picker/paper-time-picker.html">
<link rel="import" href="../../components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../components/paper-dialog/paper-dialog.html">

<link rel="import" href="../../components/paper-styles/color.html">
<link rel="import" href="../../pl-utils/arckane-styles.html">

<link rel="import" href="../../pl-utils/editor-behavior.html">

<dom-module id="edit-date">
  <style include="paper-time-picker-dialog-style"></style>
  <style include="paper-date-picker-dialog-style"></style>
  <style>
    * {
      box-sizing: border-box;
    }

    paper-slider {
      width: 100%;
    }

    .card-actions paper-button {
      @apply(--layout-flex);
      color: var(--arckane-purple-200);
    }

    .day {
      font-size: 34px;
    }

    .time {
      font-size: 20px;
    }

    .length {
      margin-top: 10px;
      font-size: 16px;
      color: var(--google-grey-500);
    }

  </style>

  <template>
    <!-- Date, time and length card -->
    <paper-card class="flex-if-desktop">

      <!-- Display -->
      <div class="card-content date">
        <div class="day">{{_dateFormat(date, 'LL')}}</div>
        <div class="time">{{time}}</div>
        <div class="length"><span>{{length}}</span> hrs.</div>
        <paper-slider pin snaps max="10" max-markers="10" step="0.5" value="{{length}}"></paper-slider>
      </div>

      <!-- Action buttons -->
      <div class="booking card-actions horizontal layout">
        <paper-button on-tap="_showDateDialog">
          <iron-icon icon="create"></iron-icon>
          Date
        </paper-button>
        <paper-button on-tap="_showTimeDialog">
          <iron-icon icon="create"></iron-icon>
          Time
        </paper-button>
      </div>

      <!-- Date picker dialog -->
      <paper-dialog id="dateDialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="_dismissDateDialog">
        <paper-date-picker id="datePicker" min-date="[[minDate]]" date="[[date]]"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>

      <!-- Time picker dialog -->
      <paper-dialog id="timeDialog" class="paper-time-picker-dialog" modal on-iron-overlay-closed="_dismissTimeDialog">
        <paper-time-picker id="timePicker" time="[[time]]"></paper-time-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>Ok</paper-button>
        </div>
      </paper-dialog>
    </paper-card>
  </template>
</dom-module>

<script>
  Polymer({

    is: "edit-date",

    behaviors: [EditorBehavior],

    properties: {
      sessionId: String,
      time: {
        type: String,
        observer: "_dateChanged"
      },
      date: {
        type: Object,
        observer: "_dateChanged"
      },
      length: {
        type: Number,
        observer: "_lengthChanged"
      }
    },

    setInitialData: function (data) {
      var dataDate = new Date(data["session_date"]);
      var hours = dataDate.getHours();
      var minutes = dataDate.getMinutes();
      var part = "";

      if (hours > 12) part = "PM";
      else part = "AM";
      if (hours > 12) hours = hours - 12;
      if (minutes < 10) minutes = "0"+minutes;
      this.time = hours+":"+minutes+" "+part;

      var utcHours = dataDate.getUTCHours();
      var utcMinutes = dataDate.getUTCMinutes();
      this.date = new Date(dataDate.getTime() - (utcHours * 60 * 60 * 1000) - (utcMinutes * 60 * 1000));

      this.minDate = new Date(data["creation_timestamp"]);
      this.length = data["length"];
    },

    _dateChanged: function (date) {
      if (this.safetyFlag) {
        var year = this.date.getFullYear();
        var month = this.date.getMonth();
        var day = this.date.getDate();
        var hour = this.$.timePicker.hour;
        var minute = this.$.timePicker.minute;
        var newDate = new Date(year, month, day, hour, minute, 0);
        this.updateData("session_date", newDate.getTime(), true, "/api/schedules/update/session/"+this.sessionId);
      }
    },

    _lengthChanged: function (length) {
      this.updateData("length", length, true, "/api/schedules/update/session/"+this.sessionId);
    },

    _showTimeDialog: function () {
      this.$.timeDialog.toggle();
    },

    _dismissTimeDialog: function(event) {
      if (event.detail.confirmed) {
        this.time = this.$.timePicker.time;
      }
    },

    _dateFormat: function(date, format) {
      return moment(date).format(format);
    },

    _dismissDateDialog: function(event) {
      if (event.detail.confirmed) {
        this.date = this.$.datePicker.date;
      }
    },

    _showDateDialog: function() {
      this.$.dateDialog.toggle();
    }
  });
</script>
