<!--
@author Francisco Miguel Aramburo Torres - atfm05@gmail.com
-->

<link rel="import" href="../../components/polymer/polymer.html">
<link rel="import" href="../../components/paper-card/paper-card.html">

<link rel="import" href="../../components/paper-input/paper-input.html">

<link rel="import" href="../../components/geo-location/geo-location.html">
<link rel="import" href="../../components/google-map/google-map.html">
<link rel="import" href="../../components/google-map/google-map-search.html">

<link rel="import" href="../../components/paper-styles/color.html">
<link rel="import" href="../../pl-utils/arckane-styles.html">

<link rel="import" href="../../pl-utils/editor-behavior.html">

<dom-module id="edit-location">
  <style include="arckane-styles"></style>
  <style>
    * {
      box-sizing: border-box;
    }

    :host {
      display: block;
      @apply(--layout-flex);
      @apply(--layout-vertical);
    }

    paper-card {
      width: 100%;
    }

    .map-container {
      width: 100%;
      height: 500px;
    }

    .card-content paper-input {
      --default-primary-color: var(--arckane-purple-200);
      --paper-input-container-focus-color: var(--arckane-purple-200);
      --paper-input-container-input-color: var(--arckane-purple-200);
    }
  </style>

  <template>
    <!-- Location -->
    <paper-card class="vertical layout flex">

      <!-- Info display -->
      <div class="card-content">
        <div class="font-XXL">{{locationName}}</div>
        <div class="font-M font-grey">{{formattedAddress}}</div>
        <paper-input label="Search address or places (try coffee!)" value="{{locationSearchInput}}"></paper-input>
      </div>

      <div class="map-container flex">

        <!-- Map search and map -->
        <geo-location latitude="{{userLatitude}}" longitude="{{userLongitude}}" high-accuracy></geo-location>
        <google-map-search
          id="mapSearch"
          map="[[map]]"
          radius="10000"
          query="{{locationSearch}}"
          results="{{locationResults}}">
        </google-map-search>
        <google-map
          id="googleMap"
          map="{{map}}"
          latitude="{{latitude}}"
          longitude="{{longitude}}"
          fit-to-markers>

          <!-- Markers -->
          <template is="dom-repeat" items="{{locationResults}}" as="marker">
            <google-map-marker latitude="{{marker.latitude}}"
                               longitude="{{marker.longitude}}"
                               z-index="{{index}}"
                               single-info-window
                               click-events>
              <h2>{{marker.name}}</h2>
              <span>{{marker.formatted_address}}</span>
            </google-map-marker>
          </template>

        </google-map>
      </div>
    </paper-card>
  </template>
</dom-module>

<script>
  Polymer({

    is: "edit-location",

    behaviors: [EditorBehavior],

    properties: {
      sessionId: String,
      locationSearchInput: {
        type: String,
        observer: "_locationSearchInputChanged"
      },
      locationResults: {
        type: Object,
        observer: "_locationResultsChanged"
      }
    },

    listeners: {
      "google-map-marker-click": "_markerTap",
      "geo-response": "_userLocationResponse"
    },

    setInitialData: function (data) {
      this.formattedAddress = data["formatted_address"];
      this.locationName = data["location_name"];
      this.latitude = data["latitude"];
      this.longitude = data["longitude"];
      this.locationResults = [{
        latitude: this.latitude,
        longitude: this.longitude
      }];
      this.$.googleMap.zoom = 17;
    },

    _userLocationResponse: function (e) {
      if (this.locationName == "Unset") {
        this.$.googleMap.longitude = this.userLongitude;
        this.$.googleMap.latitude = this.userLatitude;
      }
    },

    _locationSearchInputChanged: function (input) {
      this.debounce("typing-search-input", function () {
        this.locationSearch = input;
      }, 1000);
    },

    _locationResultsChanged: function (results) {
      if (!this.safetyFlag) return;
      if (results.length == 0) {
        this.formattedAddress = "No location found";
      } else {
        if (results[0]["formatted_address"] == this.formattedAddress) return;
        this._setLocation(0);
      }
    },

    _setLocation: function (index) {
      var results = this.locationResults;
      this.locationName = results[index]["name"];
      this.formattedAddress = results[index]["formatted_address"];
      this.latitude = results[index]["latitude"];
      this.longitude = results[index]["longitude"];
      this.updateData("formatted_address", this.formattedAddress, false, "/api/schedules/update/session/"+this.sessionId);
      this.updateData("location_name", this.locationName, false, "/api/schedules/update/session/"+this.sessionId);
      this.updateData("latitude", this.latitude, true, "/api/schedules/update/session/"+this.sessionId);
      this.updateData("longitude", this.longitude, true, "/api/schedules/update/session/"+this.sessionId);
    },

    _markerTap: function (event) {
      this._setLocation(event.target.zIndex);
    }
  });
</script>
